# Сайт лендинг для проекта Captain Morgan

## Список команд

1. Установка - npm i
2. Запуск сборщика - gulp
3. Сборка build версии - gulp build

## Инструкция по работе с деплоем

Для работы с деплоем понадобится:
1. Базовые знания git(add, commit, push, pull)
2. Хостинг, поддерживающий подключение по SSH.
3. GitHub-репозиторий с поддержкой GitHub Actions

Принцип работы: когда мы будем пушить данные в репозиторий, сработает GitHub Action, которому сказано подключиться к вашему хостингу по SSH и залить туда данные с помощью rsync.

### Создание SSH-ключа

Самое первое что надо сделать, это создать SHH клюи. Приватный и публичный. Создаем ключ в консоли Git Bush. 
Вводим следующую команду: **ssh-keygen -t rsa -b 2048**
Данная команда создаст ключи и поместит их в папку .ssh. А именно - C:\Users\ИмяПользователя.ssh. 
Если же открыть Bash в этой же папке что и проект - ключи попадут прямо в нее. **Главное не забудь удалить их оттуда чтобы они не попали в файлы репозитория!**

В этой папке находятся ключи id_rsa и id_rsa.pub, приватный и публичный ключи соответственно.

### Добавление ключей

После того как мы создали ключи, их нужно добавить на хостинг и в репозиторий.

Сначала добавим ключ на хостинг (на примере beget). У нашего хостинга есть подробная инструкция по добавлению ключей [здесь](https://beget.com/ru/kb/how-to/ssh/avtomaticheskaya-ssh-avtorizacziya-po-klyuchu)

Затем добавим ключ в наш репозиторий. Идем в репозиторий GitHub, переходим в **Settings**, оттуда переходим в **Secrets**. Внутри нужно будет назвать секрет и ввести приватный ключ (сохраните его заранее в буфер обмена). Назови ключ просто – **key**, вставляй ключ и сохраняй.

### Создаем файл для деплоя

Чтобы сделать деплой, то есть дать понять гиту, что при изменении кода надо залить его на удаленный сервер, нам нужно написать скрипт на языке Yaml. Ниже будет код, который просто нужено будет скопировать.

```yaml
name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # Setup key
      - run: set -eu
      - run: mkdir "$HOME/.ssh"
      - run: echo "${{ secrets.key }}" > "$HOME/.ssh/key"
      - run: chmod 600 "$HOME/.ssh/key"
      # Build
      - run: npm ci
      - run: gulp build
      # Deploy
      - run: cd app && rsync -e "ssh -i $HOME/.ssh/key -o StrictHostKeyChecking=no" --archive --compress --delete . baza3@baza3.beget.tech:/home/b/baza3/degorov.ru/public_html/captain-morgan
```

1. Название файла deploy.yml
2. Внутри также указан name: Deploy
3. Далее указано действие, по которому сработает скрипт - **on: push: branches: main.** То есть, когда будет что-то пушиться в ветку main – сработает скрипт. Если название ветки отличается, то нужно поменять **main** на нужное.
4. Далее указана "работа". Там описано, где именно будет запускаться все это и как.
5. Секция **#Build**. Здесь описываются действия если есть gulp. Если его нет эти строчки можно убрать. **npm ci** означает установка всех зависимостей (npm i) а **gulp build** запускает сборку проекта (билд\прод версию)
6. В секции **# Deploy** происходит сам деплой данных. **cd app** опциональная строчка, если нет сборщика либо папки app то удалить. Здесь для нас важна строка куда все это деплоить  
```yaml
	baza3@baza3.beget.tech:/home/b/baza3/degorov.ru/public_html/captain-morgan
```
Это строка полный путь до нашего сайта(можно узнать у техподдержки). В конце **public_html/captain-morgan** указал на папку куда задеплоить данные. Здесь нужно быть аккуратным и прописать правильный путь тк деплой стирает данный и записыват новые.

### Далее
В папке нашего проекта создаем папку **.gitgub** в ней создаем папку **workflows** и уже в нее расположить наш файл **deploy.yml**.

После пуша можем перейти во вкладку actions нашего репозитория и вживую посмотреть, как все команды из yml файла выполняются прямо там.
